@model UpdateUserProfileVM
@{
    ViewData["Title"] = "Account Settings";
}

<div class="row w-100">
    <div class="col-3" style="margin-top: 50px;">
        <!-- Tab navs -->
        <div class="nav flex-column nav-tabs text-center"
             id="v-tabs-tab"
             role="tablist"
             aria-orientation="vertical">
            <a data-mdb-tab-init
               class="nav-link active"
               id="v-tabs-home-tab"
               href="#v-tabs-home"
               role="tab"
               aria-controls="v-tabs-home"
               aria-selected="true">Profile</a>
            <a data-mdb-tab-init
               class="nav-link"
               id="v-tabs-profile-tab"
               href="#v-tabs-profile"
               role="tab"
               aria-controls="v-tabs-profile"
               aria-selected="false">Change Password</a>

        </div>
        <!-- Tab navs -->
    </div>

    <div class="col-9">
        <!-- Tab content -->
        <div class="tab-content" id="v-tabs-tabContent">
            <div class="tab-pane fade show active"
                 id="v-tabs-home"
                 role="tabpanel"
                 aria-labelledby="v-tabs-home-tab">
                <!-- profile content -->
                @* account/usersetings *@
                <div class="container mt-5">
                    <div class="card shadow-sm p-4">
                        <h3 class="mb-4"><i class="bi bi-person-circle me-2"></i>Your Profile</h3>
                        <form asp-controller="Account" asp-action="UpdateUserProfile" method="post">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Username</label>
                                    <input id="UserName" asp-for="NewUserName" class="form-control" />
                                    <small class="text-danger"><span asp-validation-for="NewUserName"></span></small>
                                    <span class="text-danger field-validation-error" >@ViewBag.Message</span>
                                </div>

                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <input id="Email" asp-for="Email" class="form-control" />
                                    <small class="text-danger"><span asp-validation-for="Email"></span></small>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-success">
                                     Update
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade"
                 id="v-tabs-profile"
                 role="tabpanel"
                 aria-labelledby="v-tabs-profile-tab">
                <!-- password content -->
                <div class="container mt-5">
                    <div class="card shadow-3">
                        <div class="card-body p-4">
                            <h4 class="mb-4 fw-bold"><i class="fas fa-sliders-h me-2"></i>Change Password</h4>

                            <form id="changePasswordForm" method="post">

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" name="CurrentPassword" />
                                    <span class="text-danger field-validation-error" data-valmsg-for="CurrentPassword"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" name="NewPassword" />
                                    <span class="text-danger field-validation-error" data-valmsg-for="NewPassword"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" name="ConfirmNewPassword" />
                                    <span class="text-danger field-validation-error" data-valmsg-for="ConfirmNewPassword"></span>
                                </div>

                                <div class="mt-4">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-1"></i> Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tab content -->
    </div>
</div>

@section Scripts {

    <script>
        $(document).ready(function(){

            $.ajax({
                url: "@Url.Action("GetUserDetails", "Account")",
                method: 'GET',
                success:function(data){
                    if (data.success && data.result) {
                        $("#UserName").val(data.result.userName);
                         $("#Email").val(data.result.email);
                    }
                }
            });

            // this handles change password form
            $('#changePasswordForm').on('submit', function (e) {
                e.preventDefault();

                var form = $(this);

                $.ajax({
                    url: '@Url.Action("UpdateUserPassword", "Account")',
                    method: 'POST',
                    data: form.serialize(),
                    success: function (response) {
                        if (response.success) {
                            form[0].reset();
                        } else {
                            // Clear previous errors
                            $('.field-validation-error').text('');

                            if (response.errors) {
                                // Display model state errors
                                for (var field in response.errors) {
                                    $(`[data-valmsg-for="${field}"]`).text(response.errors[field][0]);
                                }
                            }
                            console.log('Please fix the errors and try again.');
                        }
                    },
                    error: function () {
                        console.log('Something went wrong. Please try again.');
                    }
                });
            });

        });
    </script>
}